name: Staging - build changed services (PR)

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]
        paths:
            - "services/**"
            - ".github/workflows/**"

permissions:
    contents: read
    packages: write

jobs:
    detect-changes:
        name: Detect changed services
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.set-matrix.outputs.matrix }}
            has_changes: ${{ steps.set-matrix.outputs.has_changes }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Compute changed services under services/
              id: set-matrix
              shell: bash
              run: |
                  set -euo pipefail

                  BASE_SHA="${{ github.event.pull_request.base.sha }}"
                  HEAD_SHA="${{ github.sha }}"

                  # List changed files between base and head
                  CHANGED_FILES="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"

                  # Extract first-level directory names: services/<name>/...
                  SERVICES="$(echo "$CHANGED_FILES" \
                    | awk -F/ '$1=="services" && NF>=2 {print $2}' \
                    | sort -u)"

                  if [[ -z "${SERVICES}" ]]; then
                    echo "No changes under services/."
                    echo 'has_changes=false' >> "$GITHUB_OUTPUT"
                    echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  # Build JSON matrix: {"include":[{"image_name":"messenger"}, ...]}
                  JSON='{"include":['
                  first=1
                  while IFS= read -r svc; do
                    [[ -z "$svc" ]] && continue
                    if [[ $first -eq 1 ]]; then
                      first=0
                    else
                      JSON+=','
                    fi
                    JSON+='{"image_name":"'"$svc"'"}'
                  done <<< "$SERVICES"
                  JSON+=']}'

                  echo 'has_changes=true' >> "$GITHUB_OUTPUT"
                  echo "matrix=$JSON" >> "$GITHUB_OUTPUT"

    build-and-push:
        name: Build & push (changed services)
        needs: detect-changes
        if: needs.detect-changes.outputs.has_changes == 'true'
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
        uses: cloudsteak/cm-workflows/.github/workflows/staging-build-push.yml@1.2.1
        with:
            image_name: ${{ matrix.image_name }}
